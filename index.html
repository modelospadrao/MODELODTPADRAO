<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>DT - Filtro, Ordena√ß√£o e WhatsApp</title>

<style>
    body { 
        font-family: Arial, sans-serif; 
        background: #eef1f5; 
        padding: 10px 20px;
        margin: 0;
        height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-sizing: border-box;
    }
    h2 { margin-bottom: 5px; margin-top: 0; }

    /* Container fixo para cabe√ßalho e filtros */
    .header-container {
        background: #eef1f5;
        z-index: 100;
        padding-bottom: 5px;
        flex-shrink: 0;
    }

    /* Layout dos filtros em cascata */
    .filtros-cascata {
        display: flex;
        gap: 10px;
        flex-direction: row;
        justify-content: flex-start;
        align-items: stretch;
    }

    /* Wrapper da tabela com scroll INTERNO */
    .table-wrapper {
        flex: 1;
        min-height: 200px;
        overflow-y: auto;
        overflow-x: auto;
        border: 1px solid rgba(51, 51, 51, 0.4);
        border-radius: 8px;
        background: white;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }

    thead {
        position: sticky;
        top: 0;
        z-index: 10;
        background: #004c97;
    }

    th, td {
    padding: 6px 8px;
    text-align: left;
    border-left: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
    font-size: 13px;
    white-space: nowrap;
    }

    th:first-child, td:first-child {
        border-left: none;
    }

    th {
        background: #004c97;
        color: white;
        cursor: pointer;
        user-select: none;
    }

    th.selected {
        background: #0076d6 !important;
    }

    tr:hover { background: #f5faff; }

    .upload-box, .filtro-box {
        background: white;
        padding: 12px;
        width: 360px;
        border-radius: 6px;
        border: 1px solid #ccc;
        margin-bottom: 15px;
    }

    button {
        font-size: 14px;
        background-color: #444;
        color: #fff;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        padding: 6px 14px;
        box-shadow: 0 10px 0 rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
        transform: scale(1.02);
        box-shadow: 0 6px 8px rgba(0,0,0,0.15);
    }

    button:active {
        transform: scale(0.98);
    }

    button.gerado {
        background-color: green !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.5) !important;
    }

    button.realizado {
        background-color: green !important;
    }

    button.nao-realizado {
        background-color: red !important;
    }
    button.pendente {
    background-color: #FF9800 !important;
    color: #fff !important;
    }

    button.reset-btn {
        margin: 3px;
        padding: 6px 10px;
        border: none;
        background-color: #444;
        color: #fff;
        border-radius: 18px;
        cursor: pointer;
        font-size: 15px;
        box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    tr.marcado {
        background: #fff0f0 !important;
    }

    input.codigo, input.lead {
    width: 85px;
    margin: 2px;
    padding: 7px 10px;
    border: none;
    background-color: #444;
    color: #fff;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    box-shadow: 0 4px 0 rgba(0,0,0,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
    }

    input.codigo::placeholder, 
    input.lead::placeholder {
        color: #ccc;
        opacity: 35;
    }
    input.obs, input.retorno {
    width: 75px;
    padding: 8px 12px;
    border: 1px solid #979797;
    background-color: rgb(255, 255, 255);
    color: #333;
    border-radius: 2px 10px 10px 18px;
    cursor: pointer;
    font-size: 14px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.15);
    transition: transform 0.2s, box-shadow 0.2s;
    }
    .popup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px;
        background: rgba(0,0,0,0.95);
        color: #fff;
        font-size: 14px;
        border-radius: 12px;
        z-index: 10000;
        box-shadow: 0 5px 30px rgba(0,0,0,0.5);
        text-align: center;
        max-width: 90%;
        min-width: 400px;
    }

    .popup textarea {
        width: 89%;
        min-height: 468px;
        padding: 10px;
        margin: 10px 0;
        border-radius: 8px;
        border: 2px solid #666;
        background: #222;
        color: #fff;
        font-size: 14px;
        resize: vertical;
    }

    .popup-buttons {
        display: flex;
        justify-content: center;
        gap: 12px;
        margin-top: 15px;
        flex-wrap: wrap;
    }

    .popup-buttons button {
        padding: 10px 25px;
        font-size: 13px;
        border-radius: 6px;
        cursor: pointer;
        border: none;
        font-weight: bold;
    }

    .popup .yes-button {
        background: #4CAF50;
        color: #fff;
    }

    .popup .no-button {
        background: #f44336;
        color: #fff;
    }

    .popup .close-button {
        background: #666;
        color: #fff;
        margin-top: 10px;
    }

    .popup-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 9999;
    }

    .btn-exportar {
        margin: 2px;
        padding: 6px 10px;
        border: none;
        background-color: #444;
        color: #fff;
        border-radius: 18px;
        cursor: pointer;
        font-size: 15px;
        box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn-importar {
        margin: 2px;
        padding: 6px 10px;
        border: none;
        background-color: #444;
        color: #fff;
        border-radius: 18px;
        cursor: pointer;
        font-size: 15px;
        box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn-limpar-filtros {
        margin: 2px;
        padding: 6px 10px;
        border: none;
        background-color: #444;
        color: #fff;
        border-radius: 18px;
        cursor: pointer;
        font-size: 15px;
        box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }


    .btn-limpar-tudo {
        background-color: red !important;
    }

    .btn-criar-rota {
    margin: 2px;
    padding: 6px 10px;
    border: 0px solid #ff0000;
    background-color: #ff0000;
    color: #ffffff;
    border-radius: 18px;
    cursor: pointer;
    font-size: 15px;
    font-weight: bold;
    box-shadow: 0 4px 0 rgba(0,0,0,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }


    /* GR√ÅFICO DE CONTAGEM */
    .grafico-container {
        background: rgba(255, 255, 255, 0);
        padding: 6px 28px;
        
    }

    .grafico-titulo {
        font-size: 14px;
        font-weight: bold;
        margin-bottom: 6px;
        text-align: center;
        color: #004c97;
    }

    .grafico-metricas {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
    }

    .metrica-item {
        padding: 6px;
        border-radius: 6px;
        text-align: center;
        border: 2px solid #ddd;
    }

    .metrica-numero {
        font-size: 20px;
        font-weight: bold;
        display: block;
    }

    .metrica-label {
        font-size: 15px;
        color: #666;
        margin-top: 2px;
        display: block;
    }

    .metrica-total { background: #e3f2fd; border-color: #2196F3; }
    .metrica-total .metrica-numero { color: #f32121; }

    .metrica-pendente { background: #fff3e0; border-color: #FF9800; }
    .metrica-pendente .metrica-numero { color: #FF9800; }

    .metrica-criada { background: #e8f5e9; border-color: #4CAF50; }
    .metrica-criada .metrica-numero { color: #4CAF50; }

    .metrica-realizado { background: #c8e6c9; border-color: #2E7D32; }
    .metrica-realizado .metrica-numero { color: #2E7D32; }

    .metrica-nao-realizado { background: #ffebee; border-color: #f44336; }
    .metrica-nao-realizado .metrica-numero { color: #f44336; }

    .metrica-reprogramar { background: #f5f5f5; border-color: #9E9E9E; }
    .metrica-reprogramar .metrica-numero { color: #9E9E9E; }

    .metrica-inspetor { background: #263238; border-color: #000; }
    .metrica-inspetor .metrica-numero { color: #fff; }

    button.reprogramar {
        background-color: #9E9E9E !important;
    }

    button.enviar-inspetor {
        background-color: #000 !important;
        color: white !important;
    }

    /* FILTROS EM BOT√ïES (BASE / SE / ALIM) */
    #botoesBASE,
    #botoesSE,
    #botoesALIM {
        background: #ffffff;
        padding: 8px;
        border-radius: 12px;
        border: 1px solid #333;
        box-shadow: 7px 6px 5px rgba(0,0,0,0.3);
        text-align: center;
        flex: 1;
        position: relative;
        display: flex;
        flex-direction: column;
        overflow: visible;
    }

    #botoesBASE b,
    #botoesSE b,
    #botoesALIM b {
        display: block;
        margin-bottom: 6px;
        font-size: 13px;
    }

    #botoesBASE > br,
    #botoesSE > br,
    #botoesALIM > br {
        display: none;
    }

    .botoes-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(95px, 1fr));
        gap: 4px;
        padding-top: 0;
    }

    /* Container espec√≠fico da BASE - bot√µes ajust√°veis ao texto */
    #botoesBASE .botoes-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 4px;
    }

    /* Bot√µes padr√£o */
    #botoesBASE button:not(.limpar),
    #botoesSE button:not(.limpar),
    #botoesALIM button:not(.limpar) {
        margin: 0;
        padding: 6px 6px;
        border: none;
        background-color: #444;
        color: #fff;
        border-radius: 18px;
        cursor: pointer;
        font-size: 11px;
        box-shadow: 0 3px 0 rgba(0,0,0,0.15);
        transition: transform 0.2s, box-shadow 0.2s;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-width: 90px;
    }

    /* Bot√µes da BASE - ajuste autom√°tico ao texto */
    #botoesBASE button:not(.limpar) {
        min-width: auto;
        padding: 6px 10px;
        overflow: visible;
        text-overflow: unset;
    }

    /* Hover */
    #botoesBASE button:not(.limpar):hover,
    #botoesSE button:not(.limpar):hover,
    #botoesALIM button:not(.limpar):hover {
        transform: scale(1.02);
        box-shadow: 0 5px 8px rgba(0,0,0,0.2);
    }

    /* Click */
    #botoesBASE button:not(.limpar):active,
    #botoesSE button:not(.limpar):active,
    #botoesALIM button:not(.limpar):active {
        transform: scale(0.98);
    }

    /* Bot√£o ativo */
    #botoesBASE button.ativo,
    #botoesSE button.ativo,
    #botoesALIM button.ativo {
        background-color: #ffffff !important;
        color: red !important;
        border: none !important;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3) !important;
        font-weight: bold;
    }

    /* Bot√£o limpar */
    #botoesBASE button.limpar,
    #botoesSE button.limpar,
    #botoesALIM button.limpar {
        background-color: #ff4444 !important;
        color: #fff !important;
        font-weight: bold;
        position: absolute;
        top: 3px;
        right: 3px;
        padding: 2px 8px;
        font-size: 14px;
        border-radius: 50%;
        margin: 0;
        min-width: auto !important;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    /* ESCONDE o input feio */
    .status-salvamento {
        position: absolute;
        top: 5px;
        right: 15px;
        color: #28a745;
        font-size: 12px;
    }

    .acoes-sessao {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin: 5px 0;
        padding: 0;
        background: transparent;
        border: none;
        box-shadow: none;
    }

    .acoes-esquerda {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .acoes-centro {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .acoes-direita {
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 120px;
        justify-content: flex-end;
    }

    .acoes-sessao button {
        margin: 0;
        padding: 6px 14px;
        font-size: 13px;
    }

    .btn-file-input {
        padding: 6px 14px;
        background: linear-gradient(135deg, #444, #222);
        color: #fff;
        border-radius: 20px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        box-shadow: 0 4px 10px rgba(0,0,0,0.25);
        transition: all 0.25s ease;
    }

    .btn-file-input:hover {
        transform: translateY(-2px);
        background: linear-gradient(135deg, #555, #333);
    }

    .file-name {
        font-size: 12px;
        color: #666;
        font-style: italic;
        max-width: 150px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    /* Pop-up para TalkBack */
    #talkback-popup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px 30px;
        background-color: rgba(0,0,0,0.95);
        color: white;
        font-size: 16px;
        font-weight: 600;
        border-radius: 12px;
        z-index: 11000;
        box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        text-align: center;
        min-width: 300px;
        animation: popupFade 0.3s ease;
    }

    @keyframes popupFade {
        from {
            opacity: 0;
            transform: translate(-50%, -60%);
        }
        to {
            opacity: 1;
            transform: translate(-50%, -50%);
        }
    }

    #talkback-popup.success {
        border-left: 4px solid #4CAF50;
    }

    #talkback-popup.error {
        border-left: 4px solid #f44336;
    }

    #talkback-popup.info {
        border-left: 4px solid #2196F3;
    }
    /* Popup de Confirma√ß√£o de Rota */
    #popup-rota {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 0;
        background: #1a1a1a;
        color: #fff;
        border-radius: 16px;
        z-index: 10500;
        box-shadow: 0 10px 50px rgba(0,0,0,0.9);
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow: hidden;
    }

    #popup-rota h3 {
        margin: 0;
        padding: 20px 24px;
        background: #000;
        font-size: 18px;
        font-weight: 600;
        text-align: center;
        border-bottom: 1px solid #333;
    }

    #popup-rota .rota-info {
        padding: 20px 24px;
        max-height: 50vh;
        overflow-y: auto;
        background: #0a0a0a;
    }

    #popup-rota .rota-stats {
        display: flex;
        gap: 20px;
        justify-content: center;
        margin-bottom: 20px;
        padding: 15px;
        background: #1a1a1a;
        border-radius: 8px;
    }

    #popup-rota .rota-stat {
        text-align: center;
    }

    #popup-rota .rota-stat-num {
        font-size: 28px;
        font-weight: bold;
        color: #4CAF50;
        display: block;
    }

    #popup-rota .rota-stat-label {
        font-size: 12px;
        color: #999;
        margin-top: 5px;
    }

    #popup-rota .rota-lista {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    #popup-rota .rota-item {
        padding: 12px;
        margin-bottom: 8px;
        background: #1a1a1a;
        border-radius: 8px;
        border-left: 3px solid #4CAF50;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    #popup-rota .rota-numero {
        background: #4CAF50;
        color: #000;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        flex-shrink: 0;
    }

    #popup-rota .rota-detalhes {
        flex: 1;
    }

    #popup-rota .rota-equipamento {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 4px;
    }

    #popup-rota .rota-endereco {
    font-size: 11px;
    color: #666;
    margin-top: 4px;
    line-height: 1.4;
    }

    #popup-rota .rota-aviso {
        background: #ff9800;
        color: #000;
        padding: 12px;
        border-radius: 8px;
        margin-top: 15px;
        font-size: 13px;
        text-align: center;
        font-weight: 600;
    }

    #popup-rota .popup-buttons {
        display: flex;
        gap: 12px;
        padding: 20px 24px;
        background: #000;
    }

    #popup-rota .popup-buttons button {
        flex: 1;
        padding: 12px 20px;
        font-size: 14px;
        border-radius: 8px;
        cursor: pointer;
        border: none;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    #popup-rota .btn-confirmar {
        background: #4CAF50;
        color: #fff;
    }

    #popup-rota .btn-confirmar:hover {
        background: #45a049;
        transform: translateY(-2px);
    }

    #popup-rota .btn-cancelar {
        background: #333;
        color: #fff;
    }

    #popup-rota .btn-cancelar:hover {
        background: #444;
    }
    #popup-rota .rota-progresso {
    margin: 15px 0;
    background: #0a0a0a;
    border-radius: 8px;
    padding: 10px;
    }

    #popup-rota .progresso-texto {
        font-size: 12px;
        color: #999;
        margin-bottom: 8px;
        text-align: center;
    }

    #popup-rota .progresso-barra-bg {
        background: #1a1a1a;
        border-radius: 4px;
        height: 24px;
        overflow: hidden;
        border: 1px solid #333;
    }

    #popup-rota .progresso-barra-fill {
        background: linear-gradient(90deg, #4CAF50 0%, #45a049 100%);
        height: 100%;
        width: 0%;
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: bold;
        color: white;
        text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }

    #popup-rota .btn-copiar-lista {
        background: #2196F3;
        color: #fff;
        margin-top: 10px;
    }

    #popup-rota .btn-copiar-lista:hover {
        background: #1976D2;
        transform: translateY(-2px);
    }

    #popup-rota .btn-copiar-lista.copiado {
        background: #4CAF50;
    }

    .popup-rota-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.85);
        backdrop-filter: blur(4px);
        z-index: 10499;
    }
</style>
</head>
<body>
<div id="talkback-popup"></div>
<div class="popup-rota-overlay" id="popupRotaOverlay" onclick="fecharPopupRota()"></div>
<div id="popup-rota">
    <h3>üó∫Ô∏è CONFIRMAR ROTA</h3>
    <div class="rota-info" id="rotaInfo"></div>
    <div class="popup-buttons">
        <button class="btn-copiar-lista" onclick="copiarListaRota()" id="btnCopiarLista" style="display:none;">üìã Copiar Lista</button>
        <button class="btn-confirmar" onclick="confirmarRota()">‚úì Abrir no Google Maps</button>
        <button class="btn-cancelar" onclick="fecharPopupRota()">‚úï Cancelar</button>
    </div>
</div>   
<div id="popupOverlay" class="popup-overlay" onclick="fecharPopup()"></div>
<div id="popupTexto" class="popup">
    <h3 id="popupTitulo">Editar Texto</h3>
    <textarea id="popupTextarea"></textarea>
    <div class="popup-buttons">
        <button class="yes-button" onclick="salvarPopup()">‚úî Salvar</button>
        <button class="close-button" onclick="fecharPopup()">‚úñ Fechar</button>
    </div>
</div>
<h2 style="text-align: center; font-size: 25px; font-weight: 900; color: #e63946; margin: 5px 0;">MODELO CRIAR DT INSPE√á√ïES REINTERADAS E RNT</h2>

    
<span class="status-salvamento" id="statusSalvamento"></span>
<div class="acoes-sessao">
    <div class="acoes-esquerda">
        <label for="arquivoXLSX" class="btn-file-input">üìÇ Abrir arquivo</label>
        <input type="file" id="arquivoXLSX" accept=".xlsx" style="display:none;" onchange="mostrarNomeArquivo(this)">
        <span class="file-name" id="nomeArquivo"></span>
    </div>
    <div class="acoes-centro">
        <button class="btn-exportar" onclick="exportarSessao()">üíæ Exportar</button>
        <button class="btn-importar" onclick="document.getElementById('importarSessao').click()">‚èèÔ∏è Importar</button>
        <button class="btn-limpar-filtros" onclick="limparFiltros()">‚ùå Limpar Filtros</button>
        <input type="file" id="importarSessao" accept=".json" style="display:none;" onchange="importarSessao(this)">
    </div>
    <div class="acoes-direita">
        <button class="btn-criar-rota" id="btnCriarRota" onclick="criarRotaMapa()" style="display:none;">üó∫Ô∏è Criar Rota</button>
    </div>
</div>

    

<div class="header-container">
    <div class="filtros-cascata">
        <div id="botoesBASE">
            <b>BASE:</b>
        </div>

        <div id="botoesSE">
            <b>SE:</b>
        </div>

        <div id="botoesALIM">
            <b>Alimentador:</b>
        </div>
    </div>
</div>




<div class="table-wrapper">
    <table id="tabelaDT">
        <thead>
            <tr>
                <th onclick="ordenarTabela(0, this)">RANKING</th>
                <th onclick="ordenarTabela(1, this)">TIPO</th>
                <th onclick="ordenarTabela(2, this)">EQUIPAMENTO</th>
                <th onclick="ordenarTabela(3, this)">REITERADAS</th>
                <th onclick="ordenarTabela(4, this)">SE</th>
                <th onclick="ordenarTabela(5, this)">ALIMENTADOR</th>
                <th onclick="ordenarTabela(6, this)">BASE</th>
                <th onclick="ordenarTabela(7, this)">CHI</th>
                <th onclick="ordenarTabela(8, this)">DATA</th>
                <th onclick="ordenarTabela(9, this)">ENDERE√áO</th>
                <th onclick="ordenarTabela(10, this)">DT / INC</th>
                <th onclick="ordenarTabela(11, this)">OBSERVA√á√ÉO</th>
                <th onclick="ordenarTabela(12, this)">LEAD DA EQUIPE</th>
                <th onclick="ordenarTabela(13, this)">RETORNO</th>
                <th onclick="ordenarTabela(14, this)">A√á√ÉO</th>
                <th onclick="ordenarTabela(15, this)">STATUS</th>
                <th>RESET</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>
    
<!-- GR√ÅFICO DE CONTAGEM -->
    <div class="grafico-container">
        <div class="grafico-metricas">
            <div class="metrica-item metrica-total">
                <span class="metrica-numero" id="metricaTotal">0</span>
                <span class="metrica-label">Total Filtrado</span>
            </div>
            <div class="metrica-item metrica-pendente">
                <span class="metrica-numero" id="metricaPendente">0</span>
                <span class="metrica-label">Pendentes</span>
            </div>
            <div class="metrica-item metrica-criada">
                <span class="metrica-numero" id="metricaCriada">0</span>
                <span class="metrica-label">DT Criadas</span>
            </div>
            <div class="metrica-item metrica-realizado">
                <span class="metrica-numero" id="metricaRealizado">0</span>
                <span class="metrica-label">Realizados</span>
            </div>
            <div class="metrica-item metrica-nao-realizado">
                <span class="metrica-numero" id="metricaNaoRealizado">0</span>
                <span class="metrica-label">N√£o Realizados</span>
            </div>
            <div class="metrica-item metrica-reprogramar">
                <span class="metrica-numero" id="metricaReprogramar">0</span>
                <span class="metrica-label">Reprogramar</span>
            </div>
            <div class="metrica-item metrica-inspetor">
                <span class="metrica-numero" id="metricaInspetor">0</span>
                <span class="metrica-label">Enviar Inspetor</span>
            </div>
        </div>
    </div>    
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// VARI√ÅVEIS GLOBAIS
let ultimoTH = null;
let lastSortedCol = null;
let lastOrderAsc = null;
let dadosOriginais = [];
let baseSelecionada = null;
let seSelecionado = null;
let alimentadorSelecionado = null;
let inputAtualPopup = null;

// FUN√á√ÉO TALKBACK POPUP
function mostrarTalkback(mensagem, tipo = 'info', duracao = 2000) {
    const popup = document.getElementById('talkback-popup');
    popup.textContent = mensagem;
    popup.className = tipo;
    popup.style.display = 'block';
    
    setTimeout(() => {
        popup.style.display = 'none';
    }, duracao);
}
// VARI√ÅVEL GLOBAL PARA ARMAZENAR URL DA ROTA
let urlRotaAtual = '';

// ABRIR POPUP DE ROTA - VERS√ÉO OTIMIZADA SEM TRAVAMENTO
// ABRIR POPUP DE ROTA - VERS√ÉO COM INDICADORES VISUAIS ANIMADOS
async function abrirPopupRota(coordenadas, url) {
    urlRotaAtual = url;
    
    const totalPontos = coordenadas.length;
    const pontosNaRota = Math.min(totalPontos, 11);
    
    // Abre o popup PRIMEIRO
    document.getElementById('popupRotaOverlay').style.display = 'block';
    document.getElementById('popup-rota').style.display = 'block';
    document.getElementById('btnCopiarLista').style.display = 'none';
    
    let html = `
        <div class="rota-stats">
            <div class="rota-stat">
                <span class="rota-stat-num">${totalPontos}</span>
                <span class="rota-stat-label">Total de Pontos</span>
            </div>
            <div class="rota-stat">
                <span class="rota-stat-num">${pontosNaRota}</span>
                <span class="rota-stat-label">Pontos na Rota</span>
            </div>
        </div>
        <div class="rota-progresso">
            <div class="progresso-texto">
                Buscando endere√ßos: <span id="progressoNumero">0 de ${pontosNaRota}</span><br>
                <small id="progressoDetalhe" style="color: #666;">Aguarde...</small>
            </div>
            <div class="progresso-barra-bg">
                <div class="progresso-barra-fill" id="progressoBarra">0%</div>
            </div>
        </div>
        <ul class="rota-lista" id="rotaListaItens"></ul>
    `;
    
    document.getElementById('rotaInfo').innerHTML = html;
    
    // ========================================
    // üî• ADICIONA ESTILOS PARA ANIMA√á√ïES
    // ========================================
    if (!document.getElementById('estilos-animacao-rota')) {
        const style = document.createElement('style');
        style.id = 'estilos-animacao-rota';
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.5; }
            }
            
            .rota-loading {
                display: inline-block;
                width: 16px;
                height: 16px;
                border: 2px solid #333;
                border-top-color: #4CAF50;
                border-radius: 50%;
                animation: spin 0.8s linear infinite;
                margin-left: 8px;
                vertical-align: middle;
            }
            
            .rota-status-busca {
                font-size: 10px;
                color: #FF9800;
                margin-top: 4px;
                font-weight: bold;
                animation: pulse 1s ease-in-out infinite;
            }
            
            .rota-concluido {
                color: #4CAF50;
                font-weight: bold;
                animation: none;
            }
        `;
        document.head.appendChild(style);
    }
    
    // ========================================
    // üî• VALIDA√á√ÉO DE LOGRADOURO
    // ========================================
    function validarLogradouro(texto) {
    if (!texto) return false;
    
    const logradouros = [
        // Nomes completos
        /\b(rua|avenida|travessa|beco|rodovia|estrada|alameda|via|viela|ladeira|pra√ßa|caminho|marginal|contorno|passagem|setor|quadra)\b/i,
        
        // Abrevia√ß√µes com ponto (R., Av., Tv., etc)
        /\b(r\.|av\.|tv\.|bc\.|rod\.|est\.|al\.|vl\.|p√ßa|pca|lad\.|marg\.)\b/i,
        
        // üî• NOVO: Abrevia√ß√µes seguidas de n√∫mero ou v√≠rgula
        /\b(r|av|tv|bc|rod|est|al|vl|lad|marg)\s*[,\d]/i,
        
        // Abrevia√ß√µes seguidas de letra (R Maria, Av Paulista)
        /\b(r|av|tv|bc|rod|est|al|vl|lad|marg)\s+[a-zA-Z√Ä-√ø]/i,
        
        // üî• NOVO: "R." ou "R" sozinho no in√≠cio da string
        /^(r\.|r|av\.|av|tv\.|tv)\s/i
    ];
    
    return logradouros.some(regex => regex.test(texto));
    }
    
    // ========================================
    // üî• FORMATAR ENDERE√áO
    // ========================================
    function formatarEndereco(data) {
        if (!data || !data.address) return null;
        
        const addr = data.address;
        const rua = addr.road || addr.street || '';
        const numero = addr.house_number || '';
        const bairro = addr.suburb || addr.neighbourhood || addr.city_district || '';
        const cidade = addr.city || addr.town || addr.village || addr.municipality || '';
        
        let partes = [];
        if (rua) partes.push(rua);
        if (numero) partes.push(numero);
        if (bairro) partes.push(bairro);
        if (cidade) partes.push(cidade);
        
        return partes.length > 0 ? partes.join(', ') : data.display_name;
    }
    
    // ========================================
    // üî• ATUALIZAR STATUS DE UM ITEM NA LISTA
    // ========================================
    function atualizarStatusItem(indice, mensagem, concluido = false) {
        const statusElement = document.getElementById(`status-item-${indice}`);
        if (statusElement) {
            statusElement.innerHTML = mensagem;
            if (concluido) {
                statusElement.classList.add('rota-concluido');
                statusElement.classList.remove('rota-status-busca');
            }
        }
    }
    
    // ========================================
    // üî• DETECTAR COORDENADAS DUPLICADAS
    // ========================================
    const coordenadasVistas = new Map();
    
    // ========================================
    // üî• BUSCA PROGRESSIVA (5m ‚Üí 200m)
    // ========================================
    const RAIO_MAXIMO = 200;
    
    async function buscarEnderecoInteligente(latOriginal, lngOriginal, indicePonto) {
        let enderecoFallback = `${latOriginal}, ${lngOriginal}`;
        
        // Atualiza status: buscando coordenada exata
        atualizarStatusItem(indicePonto, 'üîç Buscando coordenada exata...');
        document.getElementById('progressoDetalhe').textContent = 
            `Ponto ${indicePonto + 1}: Buscando coordenada exata...`;
        
        try {
            // ‚úÖ Tenta coordenada EXATA primeiro
            let response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latOriginal}&lon=${lngOriginal}&zoom=18&addressdetails=1`);
            let data = await response.json();
            
            if (data) {
                enderecoFallback = formatarEndereco(data) || enderecoFallback;
                
                if (validarLogradouro(enderecoFallback)) {
                    console.log(`‚úÖ Ponto ${indicePonto + 1}: Endere√ßo exato encontrado`);
                    atualizarStatusItem(indicePonto, '‚úÖ Endere√ßo encontrado!', true);
                    return {
                        endereco: enderecoFallback,
                        tipo: 'exato',
                        distancia: 0
                    };
                }
            }
            
            // üî• BUSCA PROGRESSIVA: 5m ‚Üí 10m ‚Üí 20m ‚Üí 50m ‚Üí 100m ‚Üí 150m ‚Üí 200m
            const passos = [5, 10, 20, 50, 100, 150, 200].filter(r => r <= RAIO_MAXIMO);
            
            for (const raio of passos) {
                // Atualiza status visual com o raio atual
                atualizarStatusItem(indicePonto, `üîç Buscando em raio de ${raio}m...`);
                document.getElementById('progressoDetalhe').textContent = 
                    `Ponto ${indicePonto + 1}: Buscando em raio de ${raio}m...`;
                
                console.log(`üîç Ponto ${indicePonto + 1}: Tentando raio de ${raio}m...`);
                
                const deslocamento = raio / 111000;
                
                const direcoes = [
                    [deslocamento, 0],
                    [deslocamento, deslocamento],
                    [0, deslocamento],
                    [-deslocamento, deslocamento],
                    [-deslocamento, 0],
                    [-deslocamento, -deslocamento],
                    [0, -deslocamento],
                    [deslocamento, -deslocamento]
                ];
                
                for (const [dLat, dLng] of direcoes) {
                    const novaLat = parseFloat(latOriginal) + dLat;
                    const novaLng = parseFloat(lngOriginal) + dLng;
                    
                    try {
                        await new Promise(resolve => setTimeout(resolve, 300));
                        
                        response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${novaLat}&lon=${novaLng}&zoom=18&addressdetails=1`);
                        data = await response.json();
                        
                        if (data) {
                            const enderecoTeste = formatarEndereco(data);
                            
                            if (enderecoTeste && validarLogradouro(enderecoTeste)) {
                                console.log(`‚úÖ Ponto ${indicePonto + 1}: Encontrado em ${raio}m`);
                                atualizarStatusItem(indicePonto, `‚úÖ Encontrado em ${raio}m!`, true);
                                return {
                                    endereco: enderecoTeste,
                                    tipo: 'aproximado',
                                    distancia: raio
                                };
                            }
                        }
                    } catch (err) {
                        console.log(`‚ö†Ô∏è Ponto ${indicePonto + 1}: Erro ao testar raio ${raio}m`);
                    }
                }
            }
            
        } catch (error) {
            console.error(`‚ùå Ponto ${indicePonto + 1}: Erro na busca`, error);
        }
        
        console.log(`‚ö†Ô∏è Ponto ${indicePonto + 1}: Nenhum logradouro v√°lido encontrado`);
        atualizarStatusItem(indicePonto, '‚ö†Ô∏è Sem logradouro v√°lido', true);
        return {
            endereco: enderecoFallback,
            tipo: 'padrao',
            distancia: null
        };
    }
    
    // ========================================
    // üî• PROCESSA CADA COORDENADA (COM ANIMA√á√ÉO)
    // ========================================
    for (let i = 0; i < pontosNaRota; i++) {
        const c = coordenadas[i];
        const [lat, lng] = c.coordenada.split(',');
        const coordKey = `${lat},${lng}`;
        
        console.log(`\nüìç ===== PROCESSANDO PONTO ${i+1}/${pontosNaRota} =====`);
        console.log(`Equipamento: ${c.equipamento}`);
        console.log(`Coordenada: ${coordKey}`);
        
        // üî• ADICIONA O ITEM NA LISTA COM SPINNER ANIMADO
        let listaHTML = '';
        for (let j = 0; j <= i; j++) {
            const coord = coordenadas[j];
            const bordaCor = coord.isDuplicada ? '#FF9800' : (coord.enderecoCache ? '#4CAF50' : '#666');
            const icone = coord.isDuplicada ? 'üîÑ' : (j + 1);
            const isProcessando = (j === i && !coord.enderecoCache);
            
            listaHTML += `
                <li class="rota-item" style="border-left-color: ${bordaCor};">
                    <div class="rota-numero" style="background: ${bordaCor};">
                        ${icone}
                        ${isProcessando ? '<span class="rota-loading"></span>' : ''}
                    </div>
                    <div class="rota-detalhes">
                        <div class="rota-equipamento">${coord.equipamento}</div>
                        <div class="rota-ranking" style="font-size: 11px; color: #999;">
                            Ranking: ${coord.ranking}
                            ${coord.isDuplicada ? '<span style="color: #FF9800;"> ‚Ä¢ Coordenada Repetida</span>' : ''}
                        </div>
                        <div class="rota-endereco" style="font-size: 11px; color: #666; margin-top: 4px;">
                            ${coord.enderecoCache ? `üìç ${coord.enderecoCache}` : ''}
                        </div>
                        ${isProcessando ? `<div class="rota-status-busca" id="status-item-${j}">üîÑ Iniciando busca...</div>` : ''}
                        ${coord.enderecoCache && !coord.isDuplicada ? `<div class="rota-status-busca rota-concluido" id="status-item-${j}">‚úÖ Conclu√≠do</div>` : ''}
                        ${coord.isDuplicada ? `<div class="rota-status-busca rota-concluido" id="status-item-${j}">‚ö° Reutilizado</div>` : ''}
                    </div>
                </li>
            `;
        }
        
        document.getElementById('rotaListaItens').innerHTML = listaHTML;
        
        // Processa o endere√ßo
        let endereco = '';
        let isDuplicada = false;
        
        // Verifica se j√° processou essa coordenada antes
        if (coordenadasVistas.has(coordKey)) {
            endereco = coordenadasVistas.get(coordKey);
            isDuplicada = true;
            console.log(`üîÑ Coordenada DUPLICADA detectada!`);
            atualizarStatusItem(i, '‚ö° Coordenada duplicada (reutilizada)', true);
            document.getElementById('progressoDetalhe').textContent = 
                `Ponto ${i + 1}: Coordenada duplicada (reutilizando endere√ßo)`;
            await new Promise(resolve => setTimeout(resolve, 500));
        } else {
            // Busca endere√ßo inteligente
            const resultado = await buscarEnderecoInteligente(lat, lng, i);
            
            endereco = resultado.endereco;
            if (resultado.tipo === 'aproximado') {
                endereco += ` (¬±${resultado.distancia}m)`;
            } else if (resultado.tipo === 'padrao') {
                endereco = `‚ö†Ô∏è ${endereco}`;
            }
            
            // Guarda no cache
            coordenadasVistas.set(coordKey, endereco);
        }
        
        // Salva no objeto
        coordenadas[i].enderecoCache = endereco;
        coordenadas[i].isDuplicada = isDuplicada;
        
        // üî• ATUALIZA CONTADORES
        const progresso = Math.round(((i + 1) / pontosNaRota) * 100);
        document.getElementById('progressoNumero').textContent = `${i + 1} de ${pontosNaRota}`;
        document.getElementById('progressoBarra').style.width = `${progresso}%`;
        document.getElementById('progressoBarra').textContent = `${progresso}%`;
        
        // Aguarda antes do pr√≥ximo
        if (i < pontosNaRota - 1) {
            await new Promise(resolve => setTimeout(resolve, 300));
        }
    }
    
    // ========================================
    // üî• FINALIZA
    // ========================================
    document.getElementById('progressoDetalhe').textContent = '‚úÖ Busca conclu√≠da!';
    
    let htmlFinal = `
        <div class="rota-stats">
            <div class="rota-stat">
                <span class="rota-stat-num">${totalPontos}</span>
                <span class="rota-stat-label">Total de Pontos</span>
            </div>
            <div class="rota-stat">
                <span class="rota-stat-num">${pontosNaRota}</span>
                <span class="rota-stat-label">Pontos na Rota</span>
            </div>
            <div class="rota-stat">
                <span class="rota-stat-num" style="color: #FF9800;">${coordenadasVistas.size}</span>
                <span class="rota-stat-label">Coordenadas √önicas</span>
            </div>
        </div>
        <ul class="rota-lista">
    `;
    
    coordenadas.slice(0, pontosNaRota).forEach((c, i) => {
        const bordaCor = c.isDuplicada ? '#FF9800' : '#4CAF50';
        const icone = c.isDuplicada ? 'üîÑ' : (i + 1);
        
        htmlFinal += `
            <li class="rota-item" style="border-left-color: ${bordaCor};">
                <div class="rota-numero" style="background: ${bordaCor};">${icone}</div>
                <div class="rota-detalhes">
                    <div class="rota-equipamento">${c.equipamento}</div>
                    <div class="rota-ranking" style="font-size: 11px; color: #999;">
                        Ranking: ${c.ranking}
                        ${c.isDuplicada ? '<span style="color: #FF9800;"> ‚Ä¢ Coordenada Repetida</span>' : ''}
                    </div>
                    <div class="rota-endereco" style="font-size: 11px; color: #666; margin-top: 4px;">
                        üìç ${c.enderecoCache || c.coordenada}
                    </div>
                </div>
            </li>
        `;
    });
    
    htmlFinal += `</ul>`;
    
    if (totalPontos > 11) {
        htmlFinal += `
            <div class="rota-aviso">
                ‚ö†Ô∏è Google Maps limita a 10 paradas intermedi√°rias.<br>
                Apenas os primeiros 11 pontos ser√£o inclu√≠dos na rota.
            </div>
        `;
    }
    
    document.getElementById('rotaInfo').innerHTML = htmlFinal;
    document.getElementById('btnCopiarLista').style.display = 'inline-block';
    
    console.log('‚úÖ ===== BUSCA CONCLU√çDA =====');
    console.log(`Total processado: ${pontosNaRota} pontos`);
    console.log(`Coordenadas √∫nicas: ${coordenadasVistas.size}`);
}
// FECHAR POPUP DE ROTA
function fecharPopupRota() {
    document.getElementById('popupRotaOverlay').style.display = 'none';
    document.getElementById('popup-rota').style.display = 'none';
    urlRotaAtual = '';
}

// CONFIRMAR E ABRIR ROTA
function confirmarRota() {
    if (urlRotaAtual) {
        window.open(urlRotaAtual, '_blank');
        mostrarTalkback('üó∫Ô∏è Abrindo rota no Google Maps...', 'success');
        fecharPopupRota();
    }
}
// COPIAR LISTA DE ROTA
function copiarListaRota() {
    const linhas = document.querySelectorAll("#tabelaDT tbody tr");
    let texto = `üó∫Ô∏è *LISTA DE ROTA - DT CRIADAS*\n\n`;
    let contador = 1;
    
    linhas.forEach(linha => {
        if (linha.style.display !== "none") {
            const botaoAcao = linha.querySelector('td:nth-child(15) button');
            if (botaoAcao && botaoAcao.classList.contains('gerado')) {
                const equipamento = linha.children[2].innerText;
                const ranking = linha.children[0].innerText;
                const enderecoTD = linha.querySelector('td:nth-child(10)');
                const coordenada = enderecoTD.getAttribute('data-endereco');
                
                // Busca o endere√ßo no popup (se j√° foi carregado)
                const itensRota = document.querySelectorAll('.rota-item');
                let enderecoTexto = coordenada;
                
                itensRota.forEach(item => {
                    const equip = item.querySelector('.rota-equipamento');
                    if (equip && equip.textContent === equipamento) {
                        const endElement = item.querySelector('.rota-endereco');
                        if (endElement) {
                            enderecoTexto = endElement.textContent.replace('üìç ', '');
                        }
                    }
                });
                
                let linkMapa = '';
                if (coordenada && coordenada.includes(',')) {
                    const coords = coordenada.split(',');
                    if (coords.length === 2) {
                        linkMapa = `https://www.google.com/maps?q=${coords[0].trim()},${coords[1].trim()}`;
                    }
                }
                
                const enderecoLimpo = enderecoTexto
                  .replace(/\s+/g, ' ')
                  .trim();

                texto += `*${contador}. ${equipamento}*\n`;
                texto += `Ranking: ${ranking}\n`;
                texto += `üìç Endere√ßo: ${enderecoLimpo}\n`;
                texto += `üó∫Ô∏è Mapa: ${linkMapa}\n`;
                texto += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                
                contador++;
            }
        }
    });
    
    texto += `_Total: ${contador - 1} pontos_`;
    
    navigator.clipboard.writeText(texto);
    
    const botao = document.getElementById('btnCopiarLista');
    const textoOriginal = botao.innerHTML;
    botao.innerHTML = '‚úì Copiado!';
    botao.classList.add('copiado');
    
    setTimeout(() => {
        botao.innerHTML = textoOriginal;
        botao.classList.remove('copiado');
    }, 2000);
    
    mostrarTalkback('‚úì Lista copiada com endere√ßos!', 'success');
}   
// FUN√á√ïES POPUP
function abrirPopup(input, titulo) {
    inputAtualPopup = input;
    document.getElementById('popupTitulo').innerText = titulo;
    document.getElementById('popupTextarea').value = input.value || '';
    document.getElementById('popupOverlay').style.display = 'block';
    document.getElementById('popupTexto').style.display = 'block';
    document.getElementById('popupTextarea').focus();
}

function fecharPopup() {
    document.getElementById('popupOverlay').style.display = 'none';
    document.getElementById('popupTexto').style.display = 'none';
    inputAtualPopup = null;
}

function salvarPopup() {
    if (inputAtualPopup) {
        inputAtualPopup.value = document.getElementById('popupTextarea').value;
        salvarSessaoAutomatica();
    }
    fecharPopup();
}

// AUTO-SAVE
function salvarSessaoAutomatica() {
    const sessao = capturarEstadoSessao();
    localStorage.setItem('dt_sessao_atual', JSON.stringify(sessao));
    
    const status = document.getElementById('statusSalvamento');
}

// CAPTURAR ESTADO DA SESS√ÉO
function capturarEstadoSessao() {
    const linhas = Array.from(document.querySelectorAll("#tabelaDT tbody tr"));
    const dadosLinhas = linhas.map(linha => {
    const cols = linha.children;
    
    let enderecoOriginal = cols[9].getAttribute('data-endereco') || cols[9].innerText;
    
     return {
        dados: Array.from(cols).slice(0, 9).map(td => td.innerText),
        endereco: enderecoOriginal,
        codigo: cols[10].querySelector('input')?.value || '',
        obs: cols[11].querySelector('input')?.value || '',
        lead: cols[12].querySelector('input')?.value || '',
        retorno: cols[13].querySelector('input')?.value || '',
        marcado: linha.classList.contains('marcado'),
        gerado: cols[14].querySelector('button')?.classList.contains('gerado') || false,
        statusClasse: cols[15].querySelector('button')?.className || 'nao-realizado',  // ‚Üê ADICIONE
        statusTexto: cols[15].querySelector('button')?.innerText || 'N√£o Realizado'    // ‚Üê ADICIONE
       };
   });

    return {
        timestamp: new Date().toISOString(),
        dadosOriginais: dadosOriginais,
        dadosLinhas: dadosLinhas,
        filtros: {
            base: baseSelecionada,
            se: seSelecionado,
            alimentador: alimentadorSelecionado
        }
    };
}

// EXPORTAR SESS√ÉO
function exportarSessao() {
    const sessao = capturarEstadoSessao();
    const blob = new Blob([JSON.stringify(sessao, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `sessao_dt_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    mostrarTalkback('‚úÖ Sess√£o exportada com sucesso!', 'success');
}

// IMPORTAR SESS√ÉO
function importarSessao(input) {
    const arquivo = input.files[0];
    if (!arquivo) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const sessao = JSON.parse(e.target.result);
            restaurarSessao(sessao);
            mostrarTalkback('‚úÖ Sess√£o importada com sucesso!', 'success');
        } catch (erro) {
            mostrarTalkback('‚ùå Erro ao importar sess√£o: ' + erro.message, 'error', 3000);
        }
    };
    reader.readAsText(arquivo);
    input.value = '';
}

// RESTAURAR SESS√ÉO
function restaurarSessao(sessao) {
    dadosOriginais = sessao.dadosOriginais || [];
    
    const tbody = document.querySelector("#tabelaDT tbody");
    tbody.innerHTML = "";

    sessao.dadosLinhas.forEach(item => {
        const tr = document.createElement("tr");
        
        let htmlColunas = '';
        item.dados.forEach((dado) => {
            htmlColunas += `<td>${dado}</td>`;
        });
        
        let enderecoOriginal = item.endereco || "";
        let enderecoHTML = enderecoOriginal;
        if (enderecoOriginal && enderecoOriginal.includes(",")) {
            let coords = enderecoOriginal.split(",");
            if (coords.length === 2) {
                let lat = coords[0].trim();
                let lng = coords[1].trim();
                enderecoHTML = `<button onclick="window.open('https://www.google.com/maps?q=${lat},${lng}', '_blank')">üó∫Ô∏è Mapa</button>`;
            }
        }

        const botaoTexto = item.gerado ? 'DT Criada' : 'Criar DT';
        const statusTexto = item.statusTexto || 'Pendente';
        const statusClasse = item.statusClasse || 'pendente';

        const codigoVal = (item.codigo && item.codigo !== 'undefined') ? item.codigo : '';
        const obsVal = (item.obs && item.obs !== 'undefined') ? item.obs : '';
        const leadVal = (item.lead && item.lead !== 'undefined') ? item.lead : '';
        const retornoVal = (item.retorno && item.retorno !== 'undefined') ? item.retorno : '';

        tr.innerHTML = htmlColunas + `
            <td data-endereco="${enderecoOriginal}">${enderecoHTML}</td>
            <td><input maxlength="10" class="codigo" placeholder="XXXXXXXXX" value="${codigoVal}" oninput="salvarSessaoAutomatica()"></td>
            <td><input class="obs" placeholder="..." value="${obsVal}" readonly onclick="abrirPopup(this, 'Observa√ß√£o')"></td>
            <td><input class="lead" placeholder="" value="${leadVal}" oninput="aplicarMascaraLead(this)" oninput="salvarSessaoAutomatica()"></td>
            <td><input class="retorno" placeholder="..." value="${retornoVal}" readonly onclick="abrirPopup(this, 'Retorno')"></td>
            <td><button onclick="gerarMensagem(this)" ${item.gerado ? 'class="gerado"' : ''}>${botaoTexto}</button></td>
            <td><button class="${statusClasse}" onclick="toggleStatus(this)">${statusTexto}</button></td>
            <td><button class="reset-btn" onclick="resetarLinha(this)">‚Ü∫</button></td>
        `;

        if (item.marcado) tr.classList.add('marcado');
        tbody.appendChild(tr);
    });

    baseSelecionada = sessao.filtros.base;
    seSelecionado = sessao.filtros.se;
    alimentadorSelecionado = sessao.filtros.alimentador;
    
    atualizarBotoesBASE();
    aplicarFiltros();
    verificarBotaoRota();
}

// CARREGAR SESS√ÉO AO ABRIR
window.addEventListener('DOMContentLoaded', function() {
    const sessaoSalva = localStorage.getItem('dt_sessao_atual');
    if (sessaoSalva) {
        try {
            const sessao = JSON.parse(sessaoSalva);
            restaurarSessao(sessao);
            mostrarTalkback('‚úÖ Sess√£o anterior restaurada automaticamente', 'success');
        } catch (erro) {
            mostrarTalkback('‚ùå Erro ao restaurar sess√£o anterior', 'error');
        }
    }
});

// LIMPAR APENAS OS FILTROS
function limparFiltros() {
    baseSelecionada = null;
    seSelecionado = null;
    alimentadorSelecionado = null;
    
    atualizarBotoesBASE();
    aplicarFiltros();
    
    const status = document.getElementById('statusSalvamento');
    status.textContent = '‚úî Filtros limpos!';
    status.style.color = '#667eea';
    setTimeout(() => status.textContent = '', 2000);
}

// RESETAR LINHA
function resetarLinha(botaoReset) {
    const linha = botaoReset.parentNode.parentNode;
    const botaoGerar = linha.querySelector('td:nth-child(15) button');
    const botaoStatus = linha.querySelector('td:nth-child(16) button');
    
    linha.classList.remove('marcado');
    botaoGerar.classList.remove('gerado');
    botaoGerar.innerText = 'Criar DT';
    
    botaoStatus.classList.remove('realizado', 'nao-realizado', 'reprogramar', 'enviar-inspetor');
    botaoStatus.classList.add('pendente');
    botaoStatus.innerText = 'Pendente';
    
    salvarSessaoAutomatica();
    atualizarGrafico();
}

// TOGGLE STATUS (4 ESTADOS ROTATIVOS)
function toggleStatus(botao) {
    // Estados: Pendente ‚Üí Realizado ‚Üí N√£o Realizado ‚Üí Reprogramar ‚Üí Enviar Inspetor ‚Üí Pendente
    if (botao.classList.contains('pendente')) {
        botao.classList.remove('pendente');
        botao.classList.add('realizado');
        botao.innerText = 'Realizado';
    } else if (botao.classList.contains('realizado')) {
        botao.classList.remove('realizado');
        botao.classList.add('nao-realizado');
        botao.innerText = 'N√£o Realizado';
    } else if (botao.classList.contains('nao-realizado')) {
        botao.classList.remove('nao-realizado');
        botao.classList.add('reprogramar');
        botao.innerText = 'Reprogramar';
    } else if (botao.classList.contains('reprogramar')) {
        botao.classList.remove('reprogramar');
        botao.classList.add('enviar-inspetor');
        botao.innerText = 'Enviar Inspetor';
    } else {
        botao.classList.remove('enviar-inspetor');
        botao.classList.add('pendente');
        botao.innerText = 'Pendente';
    }
    salvarSessaoAutomatica();
    verificarBotaoRota();
    atualizarGrafico();
}


// ATUALIZAR GR√ÅFICO
function atualizarGrafico() {
    const linhas = document.querySelectorAll("#tabelaDT tbody tr");
    
    let total = 0;
    let pendenteDT = 0;
    let criada = 0;
    let realizado = 0;
    let naoRealizado = 0;
    let reprogramar = 0;
    let inspetor = 0;

    linhas.forEach(linha => {
        if (linha.style.display !== "none") {
            total++;
            
            const botaoAcao = linha.querySelector('td:nth-child(15) button');
            if (botaoAcao) {
                if (botaoAcao.classList.contains('gerado')) {
                    criada++;
                } else {
                    pendenteDT++;
                }
            }
            
            const botaoStatus = linha.querySelector('td:nth-child(16) button');
            if (botaoStatus) {
                if (botaoStatus.classList.contains('realizado')) {
                    realizado++;
                } else if (botaoStatus.classList.contains('nao-realizado')) {
                    naoRealizado++;
                } else if (botaoStatus.classList.contains('reprogramar')) {
                    reprogramar++;
                } else if (botaoStatus.classList.contains('enviar-inspetor')) {
                    inspetor++;
                }
            }
        }
    });

    document.getElementById('metricaTotal').textContent = total;
    document.getElementById('metricaPendente').textContent = pendenteDT;
    document.getElementById('metricaCriada').textContent = criada;
    document.getElementById('metricaRealizado').textContent = realizado;
    document.getElementById('metricaNaoRealizado').textContent = naoRealizado;
    document.getElementById('metricaReprogramar').textContent = reprogramar;
    document.getElementById('metricaInspetor').textContent = inspetor;
}

// Destacar TH selecionado
function destacarTH(th) {
    if (ultimoTH) ultimoTH.classList.remove("selected");
    if (th) th.classList.add("selected");
    ultimoTH = th;
}

// Converter data serial do Excel
function formatarData(valor) {
    if (!valor) return "";
    
    if (typeof valor === 'string' && valor.includes('/')) {
        return valor;
    }
    
    if (typeof valor === 'number') {
        const dataExcel = new Date((valor - 25569) * 86400 * 1000);
        const dia = String(dataExcel.getDate()).padStart(2, '0');
        const mes = String(dataExcel.getMonth() + 1).padStart(2, '0');
        const ano = dataExcel.getFullYear();
        return `${dia}/${mes}/${ano}`;
    }
    
    try {
        const data = new Date(valor);
        if (!isNaN(data.getTime())) {
            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const ano = data.getFullYear();
            return `${dia}/${mes}/${ano}`;
        }
    } catch (e) {
        return valor;
    }
    
    return valor;
}

// APLICAR FILTROS
function aplicarFiltros() {
    const linhas = document.querySelectorAll("#tabelaDT tbody tr");

    linhas.forEach(linha => {
        const base = (linha.children[6].innerText || "").trim();
        const se = (linha.children[4].innerText || "").trim();
        const alim = (linha.children[5].innerText || "").trim();

        const condBase = !baseSelecionada || base === baseSelecionada;
        const condSE = !seSelecionado || se === seSelecionado;
        const condAlim = !alimentadorSelecionado || alim === alimentadorSelecionado;

        linha.style.display = (condBase && condSE && condAlim) ? "" : "none";
    });

    verificarBotaoRota();
    atualizarGrafico();
}

// VERIFICAR SE DEVE MOSTRAR BOT√ÉO DE ROTA
function verificarBotaoRota() {
    const linhas = document.querySelectorAll("#tabelaDT tbody tr");
    let temDTCriada = false;

    linhas.forEach(linha => {
        if (linha.style.display !== "none") {
            const botaoAcao = linha.querySelector('td:nth-child(15) button');
            if (botaoAcao && botaoAcao.classList.contains('gerado')) {
                temDTCriada = true;
            }
        }
    });

    const btnRota = document.getElementById('btnCriarRota');
    btnRota.style.display = temDTCriada ? 'inline-block' : 'none';
}

// ========================================
// üî• VALIDADOR E NORMALIZADOR DE COORDENADAS
// ========================================
function validarENormalizarCoordenadas(texto) {
    // 1Ô∏è‚É£ Verifica se est√° vazio ou nulo
    if (!texto || texto.trim() === '') {
        console.warn('‚ö†Ô∏è Coordenada vazia');
        return null;
    }
    
    // 2Ô∏è‚É£ Remove espa√ßos extras e converte para string
    let limpo = String(texto).trim();
    
    // 3Ô∏è‚É£ Substitui separadores comuns por v√≠rgula padr√£o
    // Aceita: v√≠rgula, ponto-e-v√≠rgula, barra, pipe
    limpo = limpo.replace(/[;|/]/g, ',');
    
    // 4Ô∏è‚É£ Normaliza espa√ßos ao redor da v√≠rgula
    limpo = limpo.replace(/\s*,\s*/g, ',');
    
    // 5Ô∏è‚É£ Remove m√∫ltiplos espa√ßos internos
    limpo = limpo.replace(/\s+/g, ' ');
    
    // 6Ô∏è‚É£ Separa em partes
    let partes;
    if (limpo.includes(',')) {
        partes = limpo.split(',');
    } else if (limpo.includes(' ')) {
        partes = limpo.split(' ');
    } else {
        console.warn('‚ö†Ô∏è Coordenada sem separador v√°lido:', texto);
        return null;
    }
    
    // 7Ô∏è‚É£ Deve ter exatamente 2 partes
    if (partes.length !== 2) {
        console.warn('‚ö†Ô∏è Coordenada deve ter 2 valores (lat,lng):', texto);
        return null;
    }
    
    // 8Ô∏è‚É£ Limpa cada parte (remove caracteres inv√°lidos)
    const lat = partes[0].trim().replace(/[^\d\.\-]/g, '');
    const lng = partes[1].trim().replace(/[^\d\.\-]/g, '');
    
    // 9Ô∏è‚É£ Converte para n√∫mero
    const latNum = parseFloat(lat);
    const lngNum = parseFloat(lng);
    
    // üîü Valida se s√£o n√∫meros v√°lidos
    if (isNaN(latNum) || isNaN(lngNum)) {
        console.warn('‚ö†Ô∏è Valores n√£o num√©ricos:', { lat, lng });
        return null;
    }
    
    // 1Ô∏è‚É£1Ô∏è‚É£ VALIDA RANGE DE LATITUDE (-90 a +90)
    if (latNum < -90 || latNum > 90) {
        console.warn('‚ö†Ô∏è Latitude fora do range (-90 a +90):', latNum);
        return null;
    }
    
    // 1Ô∏è‚É£2Ô∏è‚É£ VALIDA RANGE DE LONGITUDE (-180 a +180)
    if (lngNum < -180 || lngNum > 180) {
        console.warn('‚ö†Ô∏è Longitude fora do range (-180 a +180):', lngNum);
        return null;
    }
    
    // 1Ô∏è‚É£3Ô∏è‚É£ VALIDA TAMANHO M√çNIMO (coordenadas muito curtas s√£o suspeitas)
    if (lat.length < 3 || lng.length < 3) {
        console.warn('‚ö†Ô∏è Coordenada muito curta (m√≠nimo 3 caracteres):', { lat, lng });
        return null;
    }
    
    // 1Ô∏è‚É£4Ô∏è‚É£ VALIDA TAMANHO M√ÅXIMO
    if (lat.length > 15 || lng.length > 15) {
        console.warn('‚ö†Ô∏è Coordenada muito longa (m√°ximo 15 caracteres):', { lat, lng });
        return null;
    }
    
    // 1Ô∏è‚É£5Ô∏è‚É£ Verifica se n√£o s√£o zeros (0,0 ou 0.0,0.0)
    if (latNum === 0 && lngNum === 0) {
        console.warn('‚ö†Ô∏è Coordenada inv√°lida (0,0)');
        return null;
    }
    
    // ‚úÖ TUDO OK! Retorna coordenadas normalizadas
    const coordenadaNormalizada = `${latNum},${lngNum}`;
    
    console.log(`‚úÖ Coordenada validada: "${texto}" ‚Üí "${coordenadaNormalizada}"`);
    
    return {
        original: texto,
        normalizada: coordenadaNormalizada,
        latitude: latNum,
        longitude: lngNum,
        valida: true
    };
}    
    
// CRIAR ROTA NO MAPA - VERS√ÉO FINAL OTIMIZADA
function criarRotaMapa() {
    const linhas = document.querySelectorAll("#tabelaDT tbody tr");
    const coordenadas = [];

    // üî• PARSER ROBUSTO DE COORDENADAS
    function parseCoordenadasSeguro(texto) {
        if (!texto) return null;
        
        // Remove espa√ßos extras e normaliza separadores
        const limpo = texto.trim().replace(/\s+/g, ' ');
        
        // Tenta diferentes formatos de separa√ß√£o
        let partes;
        if (limpo.includes(',')) {
            partes = limpo.split(',');
        } else if (limpo.includes(';')) {
            partes = limpo.split(';');
        } else if (limpo.includes(' ')) {
            partes = limpo.split(' ');
        } else {
            return null;
        }
        
        // Limpa e valida cada parte
        const lat = parseFloat(partes[0].trim());
        const lng = parseFloat(partes[1].trim());
        
        // Valida se s√£o n√∫meros v√°lidos e est√£o em range razo√°vel
        if (isNaN(lat) || isNaN(lng)) return null;
        if (lat < -90 || lat > 90) return null;
        if (lng < -180 || lng > 180) return null;
        
        // Retorna formatado SEM ESPA√áOS
        return `${lat},${lng}`;
    }

    // 1Ô∏è‚É£ Coleta todas as coordenadas v√°lidas
    linhas.forEach(linha => {
        if (linha.style.display !== "none") {
            const botaoAcao = linha.querySelector('td:nth-child(15) button');
            if (botaoAcao && botaoAcao.classList.contains('gerado')) {
                const enderecoTD = linha.querySelector('td:nth-child(10)');
                const endereco = enderecoTD.getAttribute('data-endereco');
                
                // üî• USA O PARSER ROBUSTO
                const resultadoValidacao = validarENormalizarCoordenadas(endereco);

                if (resultadoValidacao && resultadoValidacao.valida) {
                    coordenadas.push({
                        coordenada: resultadoValidacao.normalizada,
                        equipamento: linha.children[2].innerText,
                        ranking: linha.children[0].innerText
                    });
                    console.log(`‚úÖ Adicionado: ${linha.children[2].innerText} - ${resultadoValidacao.normalizada}`);
                } else {
                    console.warn('‚ùå Coordenada inv√°lida ignorada:', endereco);
                    mostrarTalkback(`‚ö†Ô∏è Coordenada inv√°lida ignorada: ${linha.children[2].innerText}`, 'error', 3000);
                }
            }
        }
    });

    if (coordenadas.length === 0) {
        mostrarTalkback('‚ùå Nenhum item com "DT Criada" e coordenadas v√°lidas encontrado!', 'error');
        return;
    }

    console.log('‚úÖ Total de coordenadas v√°lidas:', coordenadas.length);

    // 2Ô∏è‚É£ Caso especial: apenas 1 ponto
    if (coordenadas.length === 1) {
        const url = `https://www.google.com/maps?q=${coordenadas[0].coordenada}`;
        abrirPopupRota(coordenadas, url);
        return;
    }

    // 3Ô∏è‚É£ Monta URL da rota SEM DUPLICA√á√ÉO
    const origem = coordenadas[0].coordenada;
    const destino = coordenadas[coordenadas.length - 1].coordenada;
    
    // üî• WAYPOINTS: pega do √≠ndice 1 at√© length-2 (M√ÅXIMO 9)
    let waypoints = [];
    for (let i = 1; i < coordenadas.length - 1 && waypoints.length < 9; i++) {
        waypoints.push(coordenadas[i].coordenada);
    }

    // 4Ô∏è‚É£ Monta URL final
    let url = `https://www.google.com/maps/dir/?api=1&origin=${origem}&destination=${destino}`;
    
    if (waypoints.length > 0) {
        url += `&waypoints=${waypoints.join('|')}`;
    }

    url += '&travelmode=driving';

    console.log('üó∫Ô∏è URL da Rota:', url);
    console.log('üìç Origem:', origem);
    console.log('üìç Destino:', destino);
    console.log('üìç Waypoints (' + waypoints.length + '):', waypoints);

    // 5Ô∏è‚É£ Abre popup de confirma√ß√£o
    abrirPopupRota(coordenadas, url);
}

// ATUALIZAR BOT√ïES BASE
function atualizarBotoesBASE() {
    let divBASE = document.getElementById("botoesBASE");
    let divSE = document.getElementById("botoesSE");
    let divALIM = document.getElementById("botoesALIM");
    
    divBASE.innerHTML = "<b>BASE:</b>";
    
    let containerBotoes = document.createElement('div');
    containerBotoes.className = 'botoes-container';
    
    if (baseSelecionada) {
        let btnLimpar = document.createElement("button");
        btnLimpar.innerText = "‚úñ";
        btnLimpar.className = "limpar";
        btnLimpar.title = "Limpar BASE";
        btnLimpar.onclick = () => {
            baseSelecionada = null;
            seSelecionado = null;
            alimentadorSelecionado = null;
            atualizarBotoesBASE();
            atualizarBotoesSE();
            atualizarBotoesALIM();
            aplicarFiltros();
            atualizarGrafico();
        };
        divBASE.appendChild(btnLimpar);
    }

    let linhas = document.querySelectorAll("#tabelaDT tbody tr");
    let contagemBase = {};

    linhas.forEach(l => {
        let base = l.children[6].innerText.trim();
        if (base) contagemBase[base] = (contagemBase[base] || 0) + 1;
    });

    Object.keys(contagemBase).sort().forEach(base => {
        // Ocultar bot√£o #N/D
        if (base === "#N/D" || base === "#ND" || base.toUpperCase() === "#N/D") return;
        
        let btn = document.createElement("button");
        btn.innerText = `${base} (${contagemBase[base]})`;
        btn.onclick = () => {
            baseSelecionada = base;
            seSelecionado = null;
            alimentadorSelecionado = null;
            atualizarBotoesBASE();
            atualizarBotoesSE();
            atualizarBotoesALIM();
            aplicarFiltros();
        };
        if (baseSelecionada === base) btn.classList.add('ativo');
        containerBotoes.appendChild(btn);
    });

    divBASE.appendChild(containerBotoes);

    if (baseSelecionada) {
        atualizarBotoesSE();
    }
}

// ATUALIZAR BOT√ïES SE
function atualizarBotoesSE() {
    let divSE = document.getElementById("botoesSE");
    let divALIM = document.getElementById("botoesALIM");
    
    divSE.innerHTML = "<b>SE:</b>";
    
    let containerBotoes = document.createElement('div');
    containerBotoes.className = 'botoes-container';
    
    // Se n√£o h√° base selecionada, apenas mostra a caixa vazia
    if (!baseSelecionada) {
        divSE.appendChild(containerBotoes);
        return;
    }
    
    if (seSelecionado) {
        let btnLimpar = document.createElement("button");
        btnLimpar.innerText = "‚úñ";
        btnLimpar.className = "limpar";
        btnLimpar.title = "Limpar SE";
        btnLimpar.onclick = () => {
            seSelecionado = null;
            alimentadorSelecionado = null;
            atualizarBotoesSE();
            atualizarBotoesALIM();
            aplicarFiltros();
        };
        divSE.appendChild(btnLimpar);
    }

    let linhas = document.querySelectorAll("#tabelaDT tbody tr");
    let contagemSE = {};

    linhas.forEach(l => {
        let base = l.children[6].innerText.trim();
        let se = l.children[4].innerText.trim();
        if (base === baseSelecionada && se) {
            contagemSE[se] = (contagemSE[se] || 0) + 1;
        }
    });

    Object.keys(contagemSE).sort().forEach(se => {
        let btn = document.createElement("button");
        btn.innerText = `${se} (${contagemSE[se]})`;
        btn.onclick = () => {
            seSelecionado = se;
            alimentadorSelecionado = null;
            atualizarBotoesSE();
            atualizarBotoesALIM();
            aplicarFiltros();
        };
        if (seSelecionado === se) btn.classList.add('ativo');
        containerBotoes.appendChild(btn);
    });

    divSE.appendChild(containerBotoes);

    if (seSelecionado) {
        atualizarBotoesALIM();
    }
}

// ATUALIZAR BOT√ïES ALIMENTADOR
function atualizarBotoesALIM() {
    let divALIM = document.getElementById("botoesALIM");
    divALIM.innerHTML = "<b>Alimentador:</b>";
    
    let containerBotoes = document.createElement('div');
    containerBotoes.className = 'botoes-container';
    
    // Se n√£o h√° SE selecionada, apenas mostra a caixa vazia
    if (!seSelecionado) {
        divALIM.appendChild(containerBotoes);
        return;
    }
    
    if (alimentadorSelecionado) {
        let btnLimpar = document.createElement("button");
        btnLimpar.innerText = "‚úñ";
        btnLimpar.className = "limpar";
        btnLimpar.title = "Limpar Alimentador";
        btnLimpar.onclick = () => {
            alimentadorSelecionado = null;
            atualizarBotoesALIM();
            aplicarFiltros();
        };
        divALIM.appendChild(btnLimpar);
    }

    let linhas = document.querySelectorAll("#tabelaDT tbody tr");
    let contagemAlim = {};

    linhas.forEach(l => {
        let se = l.children[4].innerText.trim();
        let alim = l.children[5].innerText.trim();
        if (se === seSelecionado && alim) {
            contagemAlim[alim] = (contagemAlim[alim] || 0) + 1;
        }
    });

    Object.keys(contagemAlim).sort().forEach(alim => {
        let btn = document.createElement("button");
        btn.innerText = `${alim} (${contagemAlim[alim]})`;
        btn.onclick = () => {
            alimentadorSelecionado = alim;
            atualizarBotoesALIM();
            aplicarFiltros();
        };
        if (alimentadorSelecionado === alim) btn.classList.add('ativo');
        containerBotoes.appendChild(btn);
    });

    divALIM.appendChild(containerBotoes);
}

// ORDENAR TABELA
function isNumericString(s) {
    if (!s) return false;
    const cleaned = String(s).trim().replace(/\./g,'').replace(/,/g,'.').replace(/[^\d\.\-]/g,'');
    if (cleaned === "") return false;
    return !isNaN(Number(cleaned));
}

function ordenarTabela(coluna, thElement) {
    destacarTH(thElement);

    const tbody = document.querySelector("#tabelaDT tbody");
    const todas = Array.from(tbody.querySelectorAll("tr"));
    const visiveis = todas.filter(r => r.style.display !== "none");

    const sample = visiveis.map(r => {
        let cell = r.children[coluna];
        let input = cell.querySelector('input');
        let btn = cell.querySelector('button');
        return input ? input.value.trim() : (btn ? btn.innerText.trim() : cell.innerText.trim());
    }).filter(v => v !== "");

    const numericCount = sample.filter(v => isNumericString(v)).length;
    const isNumeric = sample.length > 0 && numericCount >= Math.ceil(sample.length * 0.6);

    let orderAsc;
    if (lastSortedCol === coluna) {
        orderAsc = !lastOrderAsc;
    } else {
        orderAsc = !isNumeric;
    }

    visiveis.sort((a,b) => {
        let cellA = a.children[coluna];
        let cellB = b.children[coluna];
        
        let inputA = cellA.querySelector('input');
        let inputB = cellB.querySelector('input');
        let btnA = cellA.querySelector('button');
        let btnB = cellB.querySelector('button');
        
        let va = inputA ? inputA.value.trim() : (btnA ? btnA.innerText.trim() : cellA.innerText.trim());
        let vb = inputB ? inputB.value.trim() : (btnB ? btnB.innerText.trim() : cellB.innerText.trim());

        if (isNumeric && isNumericString(va) && isNumericString(vb)) {
            const na = Number(va.replace(/\./g,'').replace(/,/g,'.').replace(/[^\d\.\-]/g,''))||0;
            const nb = Number(vb.replace(/\./g,'').replace(/,/g,'.').replace(/[^\d\.\-]/g,''))||0;
            return orderAsc ? na - nb : nb - na;
        }

        return orderAsc ? va.localeCompare(vb,'pt') : vb.localeCompare(va,'pt');
    });

    lastSortedCol = coluna;
    lastOrderAsc = orderAsc;

    visiveis.forEach(r => tbody.appendChild(r));
}

// GERAR MENSAGEM
function gerarMensagem(botao) {
    let linha = botao.parentNode.parentNode;
    let col = linha.getElementsByTagName("td");

    let codigoInput = col[10].querySelector("input");
    let codigo = codigoInput ? codigoInput.value.toUpperCase() : "";

    let obsInput = col[11].querySelector("input");
    let obs = obsInput ? obsInput.value : "";

    let leadInput = col[12].querySelector("input");
    let lead = leadInput ? leadInput.value : "";

    let enderecoTD = col[9];
    let enderecoOriginal = enderecoTD.getAttribute('data-endereco') || "";
    
    let enderecoMensagem = enderecoOriginal;
    if (enderecoOriginal && enderecoOriginal.includes(",")) {
        let coords = enderecoOriginal.split(",");
        if (coords.length === 2) {
            enderecoMensagem = `https://www.google.com/maps?q=${coords[0].trim()},${coords[1].trim()}`;
        }
    }

    let msg =
`*MODELO PARA ATENDER DT*

*Ranking:* ${col[0].innerText}
*Tipo de equipamento:* ${col[1].innerText}
*Equipamento:* ${col[2].innerText}
*Reiteradas:* ${col[3].innerText}
*SE:* ${col[4].innerText}
*Alimentador:* ${col[5].innerText}
*Base:* ${col[6].innerText}
*CHI Total:* ${col[7].innerText}
*Data √∫ltima ocorr√™ncia:* ${col[8].innerText}
*Endere√ßo:* ${enderecoMensagem}
*DT / Incid√™ncia:* ${codigo}
*Observa√ß√£o:* ${obs}
*Lead da Equipe:* ${lead}`;

    navigator.clipboard.writeText(msg);

    linha.classList.add("marcado");
    botao.classList.add("gerado");
    botao.innerText = "DT Criada";
    
    salvarSessaoAutomatica();
    verificarBotaoRota();
    atualizarGrafico();
}

// CARREGAR XLSX
document.getElementById("arquivoXLSX").addEventListener("change", function(e) {
    let arquivo = e.target.files[0];
    let reader = new FileReader();

    reader.onload = function(event) {
        let data = new Uint8Array(event.target.result);
        let workbook = XLSX.read(data, {type: "array"});
        let sheet = workbook.Sheets[workbook.SheetNames[0]];
        let json = XLSX.utils.sheet_to_json(sheet, {defval: ""});

        dadosOriginais = json;
        preencherTabela(json);
        salvarSessaoAutomatica();
    };

    reader.readAsArrayBuffer(arquivo);
});

// POPULAR TABELA
function preencherTabela(dados) {
    let tbody = document.querySelector("#tabelaDT tbody");
    tbody.innerHTML = "";

    dados.forEach(item => {
        let tr = document.createElement("tr");
        
        let enderecoOriginal = item.ENDERE√áO || "";
        let enderecoHTML = enderecoOriginal;
        
        if (enderecoOriginal && enderecoOriginal.includes(",")) {
            let coords = enderecoOriginal.split(",");
            if (coords.length === 2) {
                let lat = coords[0].trim();
                let lng = coords[1].trim();
                enderecoHTML = `<button onclick="window.open('https://www.google.com/maps?q=${lat},${lng}', '_blank')">üó∫Ô∏è Mapa</button>`;
            }
        }

        tr.innerHTML = `
            <td>${item.RANKING || ""}</td>
            <td>${item["TIPO DE EQUIPAMENTO"] || ""}</td>
            <td>${item.EQUIPAMENTO || ""}</td>
            <td>${item["QNTD. REITERADA"] || ""}</td>
            <td>${item.SE || ""}</td>
            <td>${item.ALIMENTADOR || ""}</td>
            <td>${item.BASE || ""}</td>
            <td>${item["CHI TOTAL"] || ""}</td>
            <td>${formatarData(item["DT. ULTIMA OCORR√äNCIA"] || "")}</td>
            <td data-endereco="${enderecoOriginal}">${enderecoHTML}</td>
            <td><input maxlength="10" class="codigo" placeholder="Ex: INSERIR" oninput="salvarSessaoAutomatica()"></td>
            <td><input class="obs" placeholder="..." readonly onclick="abrirPopup(this, 'Observa√ß√£o')"></td>
            <td><input class="lead" placeholder="" oninput="salvarSessaoAutomatica()"></td>
            <td><input class="retorno" placeholder="..." readonly onclick="abrirPopup(this, 'Retorno')"></td>
            <td><button onclick="gerarMensagem(this)">Criar DT</button></td>
            <td><button class="pendente" onclick="toggleStatus(this)">Pendente</button></td>
            <td><button class="reset-btn" onclick="resetarLinha(this)">‚Ü∫</button></td>
        `;

        tbody.appendChild(tr);
    });

    atualizarBotoesBASE();
    aplicarFiltros();
}
    function aplicarMascaraLead(i) { 
        let v = i.value.toUpperCase().replace(/[^A-Z0-9]/g, ''), r = ''; 
        for (let x = 0; x < v.length && x < 8; x++) { 
            if (x === 3 || x === 5) r += '-'; 
            r += v[x]; 
        } 
        i.value = r; 
    }    
</script>

</body>
</html>
